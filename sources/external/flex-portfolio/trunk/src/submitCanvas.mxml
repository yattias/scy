<?xml version="1.0" encoding="utf-8"?>
<s:NavigatorContent xmlns:fx="http://ns.adobe.com/mxml/2009" 
		   xmlns:s="library://ns.adobe.com/flex/spark" 
		   xmlns:mx="library://ns.adobe.com/flex/mx" >
	
	<fx:Script>
		<![CDATA[
			import listeners.ToggleEvent;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.core.FlexGlobals;
			import mx.events.FlexEvent;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			
			import utils.AutoSaveService;
			import utils.XMLUtilJer;
			
			private var so:SharedObject;
			private var tEvent:ToggleEvent;
			
			protected function clickHandler(dir:String, stack:Number):void {
				tEvent = new ToggleEvent(index.TOGGLE_COMMAND, true);
				tEvent.direction = dir;
				tEvent.selecTarget = stack;
				
				so = SharedObject.getLocal(index.SHAREDOBJECT_LOCAL_NAME);
				var myPattern:RegExp = /\#/gi; 
				var portfolioString:String = new String(so.data.retrievedElosFromRoolo).replace(myPattern, "@");
				
				if(FlexGlobals.topLevelApplication.url.indexOf("file:///") > -1 || FlexGlobals.topLevelApplication.url.indexOf("www-data-public") > -1) {
					dispatchEvent(tEvent);
				}
				else {
					var ass:AutoSaveService = new AutoSaveService(so.data.saveportfolio+"?missionURI="+new String(FlexGlobals.topLevelApplication.parameters.missionURI).replace("#", "@")+"&xmlContent="+encodeURI(portfolioString));	
					ass.httpService.addEventListener(ResultEvent.RESULT, assResult);
					ass.httpService.addEventListener(FaultEvent.FAULT, assFault);
					ass.sendTheMofo();
				}
			}
			
			private function assResult(evt:ResultEvent):void {
				var sLogger:Dictionary = new Dictionary();
				sLogger["tool"] = index.SHAREDOBJECT_LOCAL_NAME;
				sLogger["type"] = "build_eportfolio_view_finished";
				sLogger["elouri"] = new String(FlexGlobals.topLevelApplication.parameters.missionURI);
				new AutoSaveService(so.data.actionlogger+"?&logaction="+encodeURI(XMLUtilJer.getXMLActionLoggerObject(sLogger, null)));
				dispatchEvent(tEvent);
			}
			
			private function assFault(evt:FaultEvent):void {
				Alert.show("An error occurred when trying to save the portfolio from the submit panel.", "Portfolio post error");
			}

			public function refreshView():void {
				var so:SharedObject = SharedObject.getLocal(index.SHAREDOBJECT_LOCAL_NAME);
				
				var sLogger:Dictionary = new Dictionary();
				sLogger["tool"] = index.SHAREDOBJECT_LOCAL_NAME;
				sLogger["type"] = "build_eportfolio_view_started";
				sLogger["elouri"] = new String(FlexGlobals.topLevelApplication.parameters.missionURI);
				new AutoSaveService(so.data.actionlogger+"?&logaction="+encodeURI(XMLUtilJer.getXMLActionLoggerObject(sLogger, null)));
				
				submitBox.selectedIndex = so.data.currentEloCategory.obliEloNum;
				(submitBox.selectedChild as submitCanvasNavigator).refreshView();
			}

			private function submitBox_creationCompleteHandler(event:FlexEvent):void {
				var submitcanvasnav:submitCanvasNavigator;
				for(var i:Number = 1; i < index.obligElos.length; i++) {
					submitcanvasnav = new submitCanvasNavigator();
					submitcanvasnav.percentWidth = 100;
					submitcanvasnav.percentHeight = 100;
					submitcanvasnav.catname = (index.obligElos[i]).label;
					submitBox.addChild(submitcanvasnav);
				}
			}

		]]>
	</fx:Script>
	
	<s:VGroup width="100%" height="100%">
		<s:HGroup id="hbo" width="100%" height="70" horizontalAlign="center" verticalAlign="middle" gap="3">
			<s:BorderContainer id="headerLogo" width="70" height="70" borderStyle="solid" borderColor="{index.THEME_COL}">
				<s:backgroundFill>
					<s:LinearGradient rotation="90">
						<s:GradientEntry color="{index.THEME_COL}" />
						<s:GradientEntry color="{index.THEME_COL}" />
					</s:LinearGradient>
				</s:backgroundFill>
				
				<s:Image source="{index.IMAGE_BASE_URL+'assets/images/folder.png'}" width="60" height="60" left="5" top="5" />
			</s:BorderContainer>	
			<s:BorderContainer id="header" width="100%" height="70" borderStyle="solid" borderColor="{index.THEME_COL}">
				<s:backgroundFill>
					<s:LinearGradient rotation="90">
						<s:GradientEntry color="{index.THEME_COL}" />
						<s:GradientEntry color="{index.THEME_COL}" />
					</s:LinearGradient>
				</s:backgroundFill>
				
				<s:HGroup width="100%" height="100%" horizontalAlign="center" verticalAlign="middle">
					<s:Label id="headerText" width="60%" color="{index.BACK_GRADIENT_BOT}" fontSize="15" textAlign="center" text="{resourceManager.getString('resources', 'SUBMIT_HEADER')}" />
				</s:HGroup>
			</s:BorderContainer>	
		</s:HGroup>
		
		<s:BorderContainer width="{hbo.width}" minHeight="10">
			<s:HGroup left="2" top="2" right="2" bottom="2" verticalAlign="middle">
				<s:Image source="{index.IMAGE_BASE_URL+'assets/images/inf.png'}" width="10" height="10" />
				<s:Label id="instruc" width="100%" height="13" text="{resourceManager.getString('resources', 'SUBMIT_INSTRUC')}" verticalAlign="middle" />
			</s:HGroup>
		</s:BorderContainer>
		
		<mx:Accordion id="submitBox" color="0x323232" width="{hbo.width}" height="100%" creationPolicy="all" creationComplete="submitBox_creationCompleteHandler(event)" />
		
		<s:HGroup id="submitFooter" width="100%" height="40" horizontalAlign="center" gap="10" verticalAlign="middle">
			<s:Button id="okSubmit" label="{resourceManager.getString('resources', 'SUBMIT_BUTTON')}" click="clickHandler(index.LEFT_DIRECTION, index.STACK_SENDING_PANEL)" />
			<s:Button id="backSubmit" label="{resourceManager.getString('resources', 'BACK_BUTTON')}" click="clickHandler(index.RIGHT_DIRECTION, index.STACK_INTRO_PANEL)" />
		</s:HGroup>
	</s:VGroup>	
</s:NavigatorContent>
